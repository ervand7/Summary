etcd Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ.
reverse-proxy Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ ÐµÑ‘ Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ÑÑ Ð½Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· watch.
Ð—Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð½Ð¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ñ…Ð¾Ð´ÑÑ‚ Ð² etcd.

---

## Ð Ð¾Ð»Ð¸ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²

### ðŸ”¹ Control Plane

* Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Ð»ÑŽÐ´ÐµÐ¹ / CI / GitOps
* Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÑ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³
* Ð¿Ð¸ÑˆÐµÑ‚ Ð½Ð¾Ð²ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð² etcd

---

### ðŸ”¹ etcd

* strongly consistent key-value store
* Ñ…Ñ€Ð°Ð½Ð¸Ñ‚:
  * routes
  * upstreams
  * policies
  * version
* ÑƒÐ¼ÐµÐµÑ‚ watch â€” ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÑÑ‚ÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‡Ð¸ÐºÐ¾Ð² Ð¾Ð± Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÑ…

---

### ðŸ”¹ Reverse Proxy (ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¸Ð½ÑÑ‚Ð°Ð½Ñ)

* Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ:
  1. Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð¸Ð· etcd
  2. ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ in-memory ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹
  3. Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ HTTP/TLS listeners
* Ð·Ð°Ñ‚ÐµÐ¼:

  * ÑÑ‚Ð°Ð²Ð¸Ñ‚ watch Ð½Ð° ÐºÐ»ÑŽÑ‡Ð¸ Ð² etcd
  * Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°ÐµÑ‚ Ñ‚Ñ€Ð°Ñ„Ð¸Ðº Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð· Ð¿Ð°Ð¼ÑÑ‚Ð¸

---

## Ð§Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ watch Ð² ÑÑ‚Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ

Watch (Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ð² etcd) â€” ÑÑ‚Ð¾ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° proxy Ð½Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð² etcd.

ÐŸÑ€Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸:

* proxy Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ Ð´Ð¾Ð»Ð³Ð¾Ð¶Ð¸Ð²ÑƒÑ‰ÐµÐµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ñ etcd
* Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚:
  *Â«ÑÐ¾Ð¾Ð±Ñ‰Ð°Ð¹ Ð¼Ð½Ðµ, ÐµÑÐ»Ð¸ `/config/*` Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑÑÂ»*
* etcd Ð½Ðµ Ð¿ÑƒÑˆÐ¸Ñ‚ ÑÐ°Ð¼ Ð¿Ð¾ ÑÐµÐ±Ðµ,
  Ð½Ð¾ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÑ‚ Ð²ÑÐµÑ…, ÐºÑ‚Ð¾ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð»ÑÑ

ðŸ‘‰ Ð­Ñ‚Ð¾ Ð½Ðµ polling Ð¸ Ð½Ðµ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹.

---

## ÐŸÐ¾ÑˆÐ°Ð³Ð¾Ð²Ð¾: Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°

1ï¸âƒ£ ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ð¼ÐµÐ½ÑÐµÑ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³
2ï¸âƒ£ Control Plane Ð¿Ð¸ÑˆÐµÑ‚ Ð½Ð¾Ð²ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð² etcd
3ï¸âƒ£ etcd Ñ€Ð°ÑÑÑ‹Ð»Ð°ÐµÑ‚ watch-event Ð²ÑÐµÐ¼ proxy
4ï¸âƒ£ ÐšÐ°Ð¶Ð´Ñ‹Ð¹ proxy:

* Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ
* Ð¿ÐµÑ€ÐµÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³
* ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ Ð½Ð¾Ð²ÑƒÑŽ in-memory ÐºÐ¾Ð¿Ð¸ÑŽ
* Ð°Ñ‚Ð¾Ð¼Ð°Ñ€Ð½Ð¾ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ð½Ð° Ð½ÐµÑ‘

âœ” ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÑŽÑ‚ÑÑ ÑÐ¾ ÑÑ‚Ð°Ñ€Ñ‹Ð¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¾Ð¼
âœ” Ð½Ð¾Ð²Ñ‹Ðµ Ð¸Ð´ÑƒÑ‚ Ð¿Ð¾ Ð½Ð¾Ð²Ð¾Ð¼Ñƒ

---

## ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ Ñ‚Ð°Ðº Ð´ÐµÐ»Ð°ÑŽÑ‚

* etcd Ð½Ðµ Ð² hot path
* Ð½ÐµÑ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ¾Ð²
* Ð½ÐµÑ‚ â€œÐ¿Ð¾Ð»Ð¾Ð²Ð¸Ð½Ñ‡Ð°Ñ‚Ñ‹Ñ…â€ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¾Ð²
* Ð²ÑÐµ proxy Ð¿Ñ€Ð¸Ñ…Ð¾Ð´ÑÑ‚ Ðº Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ð¾Ð¼Ñƒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÑŽ
* Ð²Ñ‹ÑÐ¾ÐºÐ°Ñ Ð½Ð°Ð´Ñ‘Ð¶Ð½Ð¾ÑÑ‚ÑŒ

---

## ÐžÑ‡ÐµÐ½ÑŒ Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ ÑÑ…ÐµÐ¼Ð°

```
[ Control Plane ] ---> write ---> [ etcd ]
                                /   |   \
                           watch   watch   watch
                              |       |       |
                          [ Proxy ] [ Proxy ] [ Proxy ]
                           (local in-memory config)
```
